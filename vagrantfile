# This is a vagrant file for creating a Virtual Development environment
# Usage :
# vagrant init
# vagrant up
# vagrant reload --provision
# vagrant destroy
Vagrant.configure("2") do |config|
  config.vm.box = "gusztavvargadr/ubuntu-desktop"
  config.vm.network "forwarded_port", guest: 8080, host: 8080
  config.vm.network "private_network", ip: "192.168.56.10"
  config.vm.provider "virtualbox" do |vb|
    # Display the VirtualBox GUI when booting the machine
    vb.gui = true
    vb.memory = "8192"
    vb.cpus = 6
  end

  # Mount local folder
  config.vm.synced_folder "/Users/nbossard/backend", "/home/vagrant/backend"

  # Update OS
  config.vm.provision "shell", inline: <<-SHELL
    echo "updating OS"
    sudo apt-get update -yes
    sudo apt-get upgrade --assume-yes
  SHELL

  # Change language to french
  config.vm.provision "shell", inline: <<-SHELL
    echo "changing language to french"
    sudo apt-get install --assume-yes language-pack-fr
    sudo update-locale LANG=fr_FR.UTF-8
    sudo update-locale LANGUAGE=fr_FR.UTF-8
    sudo update-locale LC_ALL=fr_FR.UTF-8
    sudo update-locale LC_CTYPE=fr_FR.UTF-8
    sudo update-locale LC_MESSAGES=POSIX
    sudo update-locale LC_COLLATE=fr_FR.UTF-8
    sudo update-locale LC_MONETARY=fr_FR.UTF-8
    sudo update-locale LC_NUMERIC=fr_FR.UTF-8
    sudo update-locale LC_TIME=fr_FR.UTF-8
  SHELL

  # Change keyboard layout to french mac
  config.vm.provision "shell", inline: <<-SHELL
    echo "changing keyboard layout to french mac"
    sudo sed -i 's/XKBLAYOUT="us"/XKBLAYOUT="fr"/g' /etc/default/keyboard
    sudo sed -i 's/XKBVARIANT="mac"/XKBVARIANT="mac"/g' /etc/default/keyboard
    sudo sed -i 's/XKBMODEL="pc105"/XKBMODEL="pc105"/g' /etc/default/keyboard
    sudo sed -i 's/XKBOPTIONS=""/XKBOPTIONS=""/g' /etc/default/keyboard
    sudo sed -i 's/BACKSPACE="guess"/BACKSPACE="guess"/g' /etc/default/keyboard
    sudo sed -i 's/COMPOSEKEY=""/COMPOSEKEY=""/g' /etc/default/keyboard
    sudo sed -i 's/TOGGLE=""/TOGGLE=""/g' /etc/default/keyboard
  SHELL


  # update vim to the latest version
  config.vm.provision "shell", inline: <<-SHELL
    echo "Updating vim"
    sudo add-apt-repository ppa:jonathonf/vim
    sudo apt-get update
  SHELL

  # Install Neovim
  config.vm.provision "shell", inline: <<-SHELL
    echo "Installing neovim"
    sudo apt-get install software-properties-common -y
    sudo add-apt-repository ppa:neovim-ppa/stable -y
    sudo apt-get update
    sudo apt-get install neovim -y
  SHELL

  # Install nodejs (required for coc.nvim)
  config.vm.provision "shell", inline: <<-SHELL
    echo "Installing nodejs"
    curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -
    sudo apt-get install -y nodejs
  SHELL

  # Install a good terminal font
  # Such as : Hack Nerd Font Mono
  # On mac :
  # brew tap homebrew/cask-fonts
  # brew install --cask font-hack-nerd-font
  config.vm.provision "shell", inline: <<-SHELL
    echo "Installing Hack Nerd Font Mono"
    mkdir -p ~/.local/share/fonts
    cd ~/.local/share/fonts && curl -sfLo "Droid Sans Mono for Powerline Nerd Font Complete.otf" https://github.com/ryanoasis/nerd-fonts/raw/master/patched-fonts/DroidSansMono/complete/Droid%20Sans%20Mono%20Nerd%20Font%20Complete.otf
    echo "TODO change font in term preferences"
  SHELL

  # Install a good terminal
  # Wezterm
  # On mac :
  # brew tap wez/wezterm
  # brew install --cask wez/wezterm/wezterm
  config.vm.provision "shell", inline: <<-SHELL
    echo "Installing Wezterm"
    curl -sLO https://github.com/wez/wezterm/releases/download/20220905-102802-7d4b8249/wezterm-20220905-102802-7d4b8249.Ubuntu20.04.deb
    sudo apt-get install -y ./wezterm-20220905-102802-7d4b8249.Ubuntu20.04.deb
  SHELL

  # Install Golang
  config.vm.provision "shell", inline: <<-SHELL
    echo "Installing golang os version"
    sudo apt-get install golang-go --assume-yes
    echo "Installing go latest version"
    FILE=/home/vagrant/go1.17.13.linux-amd64.tar.gz
    if [ ! -f "$FILE" ]; then
      echo "$FILE does not exist downloading it"
      wget -q $FILE
    fi
    echo "export PATH=/usr/local/go/bin:\$PATH" >> /home/vagrant/.bashrc
    echo "export GOPATH=\$HOME/go" >> /home/vagrant/.bashrc
    echo "export PATH=\$PATH:\$GOPATH/bin" >> /home/vagrant/.bashrc
  SHELL

  # Install chrome
  config.vm.provision "shell", inline: <<-SHELL
    echo "Installing chrome"
    sudo sh -c 'echo "deb [arch=amd64] https://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list'
    wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
    sudo apt-get update
    sudo apt-get install google-chrome-stable
  SHELL

  # Install password managers
  config.vm.provision "shell", inline: <<-SHELL
    echo "Installing password manager pass"
    sudo apt-get install pass --assume-yes
  SHELL

  # Install bookmark manager
  config.vm.provision "shell", inline: <<-SHELL
    echo "Installing buku bookmark manager"
    sudo apt-get install buku --assume-yes
  SHELL

  # Retrieving vim config from github
  config.vm.provision "shell", inline: <<-SHELL
    set -x #echo on
    echo "Retrieving vim config from github"
    # rm -rf /home/vagrant/.vim
    runuser -l vagrant -c 'git clone https://github.com/nbossard/dotvim.git /home/vagrant/.vim'
    rm /home/vagrant/.vimrc
    ln -s /home/vagrant/.vim/vimrc /home/vagrant/.vimrc
    rm /home/vagrant/.ideavimrc
    ln -s /home/vagrant/.vim/vimrc /home/vagrant/.ideavimrc
    rm -rf /home/vagrant/.config/nvim
    mkdir /home/vagrant/.config/nvim
    ln -s /home/vagrant/.vim/vimrc /home/vagrant/.config/nvim
    cd /home/vagrant/.vim

    echo "Install vim-plug"
    su - Vagrant
    echo "I am $USER, with uid $UID"'
    curl -fLo /home/vagrant/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  SHELL

  # Install taskwarrior
  config.vm.provision "shell", inline: <<-SHELL
    echo "Installing taskwarrior"
    sudo apt-get install buku --assume-yes
    echo "Linking to config of taskwarrior"
    su - Vagrant
    rm .taskrc
    ln -s dotfiles/taskrc .taskrc
  SHELL

  #


end
